name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  security-events: write
  id-token: write

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
      - name: Run golangci-lint
        run: $(go env GOPATH)/bin/golangci-lint run

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
      - name: Build for scan
        run: go build -o stinky ./cmd/stinky
      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          file: ./stinky
          artifact-name: sbom.spdx.json
      - name: Scan Vulnerabilities (Grype)
        uses: anchore/scan-action@v3
        with:
          path: "."
          fail-build: false
          output-format: sarif
      - name: Upload Grype Scan Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

  release:
    name: Build & Release
    needs: [lint, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.8.1
      - name: Create Version Tag
        run: |
          VERSION="1.0.${{ github.run_number }}"
          git tag $VERSION
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ env.VERSION }}
      
      # For deployment, we'll need the artifacts from 'dist'
      - name: Upload built packages
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: dist/*.deb

  deploy:
    name: Deploy to VPS
    needs: release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: packages
          path: pkg
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: 143.244.181.38
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            # Find the latest deb package
            DEB_PKG=$(ls /tmp/stinkykitty_*.deb | sort -V | tail -n 1) # Wait, need to sync first
            # We'll use scp to transfer first
      - name: Copy package to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 143.244.181.38
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          source: "pkg/*.deb"
          target: "/tmp"
          strip_components: 1
      - name: Install package on VPS
        uses: appleboy/ssh-action@v1.2.1
        with:
          host: 143.244.181.38
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            DEB_PKG=$(ls -t /tmp/stinkykitty_*.deb | head -n 1)
            dpkg -i $DEB_PKG
            systemctl enable stinkykitty
            systemctl restart stinkykitty
            rm $DEB_PKG
